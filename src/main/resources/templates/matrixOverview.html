{#include layout title="Competency Matrix"}
    {#content}
        <nav class="breadcrumb">
            <a href="/">Home</a> &gt;
            <span>Competency Matrix</span>
        </nav>

        <hgroup>
            <h1>Competency Matrix</h1>
            <p>Overview of all competencies across all roles</p>
        </hgroup>

        {#if allowReload}
        <div class="matrix-actions">
            <button
                hx-post="/matrix/reload"
                hx-swap="none"
                hx-indicator=".reload-indicator"
                hx-on="htmx:afterRequest: if (event.detail.xhr.status === 200) { window.location.href = '/matrix'; }"
                class="btn btn-warning"
                onclick="return confirm('This will delete all current data and reload from seed files. Continue?')">
                ðŸ”„ Reload Database
            </button>
            <div class="reload-indicator htmx-indicator">Reloading database...</div>
        </div>
        {/if}

        {#if matrix.categories && matrix.categories.size() > 1}
            <div class="matrix-filters">
                <form method="GET" action="/matrix" class="filter-form">
                    <label for="categoryFilter">Filter by Category:</label>
                    <select name="category" id="categoryFilter" onchange="this.form.submit()">
                        <option value="">All Categories</option>
                        {#for category in matrix.categories}
                            <option value="{category.id}" 
                                    {#if matrix.selectedCategoryId == category.id.toString()}selected{/if}>
                                {category.name}
                            </option>
                        {/for}
                    </select>
                    <noscript>
                        <button type="submit">Apply Filter</button>
                    </noscript>
                </form>
            </div>
        {/if}

        {#if matrix.rolesInOrder.isEmpty()}
            <p>No roles found. Please load seed data first.</p>
        {#else}
            <div class="matrix-container">
                <table class="matrix-table">
                    <thead>
                        <tr>
                            <th class="skill-header">Skill</th>
                            {#for entry in matrix.rolesByFamily.entrySet()}
                                {#for roleInfo in entry.value}
                                    <th class="role-header" title="{roleInfo.name}">
                                        <a href="/roles/{roleInfo.id}" class="role-name-link" title="View details for {roleInfo.name}">
                                            <div class="role-name">{roleInfo.name}</div>
                                        </a>
                                    </th>
                                {/for}
                            {/for}
                        </tr>
                    </thead>
                    <tbody>
                        {#for skillEntry in matrix.matrix.entrySet()}
                            <tr>
                                <th class="skill-header">
                                    <a href="/skills/{skillEntry.value.values().iterator().next.skillId}" class="skill-name-link" title="View details for {skillEntry.key}">
                                        {skillEntry.key}
                                    </a>
                                </th>
                                {#for roleInfo in matrix.rolesInOrder}
                                    {#let cell=skillEntry.value.get(roleInfo.name)}
                                    <td class="matrix-cell {cell.levelCssClass}">
                                        {#if !cell.isEmpty}
                                            <button
                                                class="level-badge-button"
                                                popovertarget="tooltip-{cell.skillId}-{cell.roleId}"
                                                hx-get="/matrix/tooltips/skill/{cell.skillId}?level={cell.level.name()}"
                                                hx-trigger="mouseenter once, focus once"
                                                hx-target="#tooltip-{cell.skillId}-{cell.roleId}"
                                                hx-swap="innerHTML"
                                                aria-describedby="tooltip-{cell.skillId}-{cell.roleId}">
                                                <span class="level-badge">{cell.displayText}</span>
                                            </button>
                                            <div
                                                popover="manual"
                                                id="tooltip-{cell.skillId}-{cell.roleId}"
                                                role="tooltip"
                                                class="tooltip-popover">
                                                <div class="tooltip-loading" aria-busy="true">Loading...</div>
                                            </div>
                                        {/if}
                                    </td>
                                    {/let}
                                {/for}
                            </tr>
                        {/for}
                    </tbody>
                </table>
            </div>
        {/if}
    {/content}
{/include}
